
[ENG-1544] Refactor large files over 1k lines to improve maintainability
Status: Todo

Description:
Three critical files exceed 1,000 lines and should be refactored to \~800 lines following language-specific best practices. This will improve code maintainability, testability, and developer experience.

## Key Details

* **SessionDetail.tsx** (1,756 lines): React component with 350-line display function and mixed concerns
* **sqlite.go** (1,424 lines): Database store mixing migrations, CRUD ops, and multiple domains
* **manager.go** (1,033 lines): Session manager handling launching, monitoring, and continuation

## Implementation Notes

**SessionDetail.tsx**: Create component directory structure with:

* Separate display components by event type
* Extract existing sub-components (DenyForm, TodoWidget, etc.)
* Custom hooks for navigation and approval logic
* Utils for helper functions

**sqlite.go**: Split by domain following repository pattern:

* migrations.go for schema management
* session_store.go, conversation_store.go, approval_store.go for domain ops
* Keep interfaces in main file

**manager.go**: Divide by session lifecycle:

* launcher.go for session creation
* monitor.go for event processing
* continue.go for session resumption

## Related Work

* [ENG-1479](https://linear.app/humanlayer/issue/ENG-1479/display-claude-sub-task-events-hierarchically-in-wui-conversation-view): Hierarchical sub-task display - adds collapsible task groups and nesting logic
* [ENG-1501](https://linear.app/humanlayer/issue/ENG-1501/show-tool-output-in-event-stream): Tool output display - adds abbreviated tool output rendering

Both tickets will add significant complexity to SessionDetail.tsx, making this refactor even more critical.

## References

* Source: `thoughts/shared/research/2025-07-07_17-08-53_refactoring_large_files.md` ([View on GitHub](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-07-07_17-08-53_refactoring_large_files.md))
* Related code:
  * `humanlayer-wui/src/components/internal/SessionDetail.tsx`
  * `hld/store/sqlite.go`
  * `hld/session/manager.go`

Comments:
[2025-07-08 17:52:08] allison@humanlayer.dev:
## Context on SessionDetail.tsx Refactoring

After analyzing ENG-1479 and ENG-1501, it's clear that SessionDetail.tsx is a critical bottleneck:

**ENG-1479 (Hierarchical sub-tasks)** will add:
- Task grouping logic with expand/collapse functionality
- Nested rendering based on `parent_tool_use_id`
- Visual hierarchy indicators (indentation, backgrounds, borders)
- Breadcrumb navigation for deep nesting
- Progress indicators for active tasks

**ENG-1501 (Tool output display)** will add:
- Tool result rendering logic
- Abbreviated display modes for large outputs (file reads, etc.)
- Potentially expand/collapse for full output viewing
- Different rendering strategies per tool type

Both features require adding significant display logic to the already massive 350-line `eventToDisplayObject` function. This refactoring should ideally happen **before** implementing these features to avoid:
1. Merge conflicts in a 1,700+ line file
2. Making the file even more unwieldy (potentially 2,000+ lines)
3. Difficulty testing the new features in isolation

### Recommended Approach
1. **Phase 1**: Refactor SessionDetail.tsx as outlined in this ticket
2. **Phase 2**: Implement ENG-1479 using the new component structure
3. **Phase 3**: Implement ENG-1501 in the refactored display components

This sequence allows each feature to be implemented in focused, testable components rather than adding to the monolith.

[2025-07-08 07:36:09] Dexter Horthy:
oh damn i was just about to make a ticket about this. My proposal was a little more janky ðŸ™‚ just run a github actions cron every night w/ claude code "pick the largest file in humanlayer-wui and refactor it cleanly"

[2025-07-08 08:25:05] Sundeep Malladi:
Thanks for making this @allison, these should maybe become three separate tickets?

[2025-07-08 08:29:50] allison@humanlayer.dev:
Yeppers, and really only I care about SessionDetail originally. The other 2 are easier. And sqlite one can happen at the same time as the migration ticket actually (There are probably 150-200 lines of just the janky migration code in it for example)


View in Linear: https://linear.app/humanlayer/issue/ENG-1544/refactor-large-files-over-1k-lines-to-improve-maintainability
