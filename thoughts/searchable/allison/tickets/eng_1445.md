
[ENG-1445] "Local Approvals" - Allowing approve/deny without HumanLayer involvement
Status: ready for dev
Assignee: allison@humanlayer.dev

Description:
basics - make it work locally, same api

iteration 0 - match the api exactly, just take humanlayer out of the loop and go straight to the daemon

longer term, these  should each be a separate spec, but

1. get better api that includes file context, etc
2. more persistent approval options like "yes for this session" or "yes forever"
3. 

---

## Implementation Plan

This implementation adds a `local_approvals` configuration flag that routes approvals through the hld daemon instead of the HumanLayer cloud API.

**Key Architecture Change:**

* Current: `MCP Server → HumanLayer SDK → HumanLayer Cloud API`
* New (when local_approvals=true): `MCP Server → Daemon Client → hld daemon → Local SQLite`

### Implementation Steps

1. **Add Configuration Flag** - Add `local_approvals` to hlyr and hld config systems
2. **Create Approvals Table** - Add dedicated SQLite table for local approvals
3. **Add RPC Method** - Single `createLocalApproval` RPC endpoint
4. **Update Approval Manager** - Handle both local and cloud approvals seamlessly
5. **Add Daemon Client to MCP** - Route MCP approvals through daemon when flag is set
6. **Update Correlation Logic** - Ensure local approvals correlate with tool calls

### Architecture Decisions

* **Single MCP Command with Config Flag** - Use existing `mcp claude_approvals` with config flag instead of new command
* **Separate Approvals Table** - Clean separation from conversation_events
* **Local Approval ID Format** - Use `local_` prefix for easy routing
* **Daemon-First Architecture** - Centralize approval management in daemon

### Migration Path

For users: simply add `"local_approvals": true` to `humanlayer.json` or set `HUMANLAYER_LOCAL_APPROVALS=true`. No Claude Code, wui, or wui configuration or code changes needed.

See `thoughts/allison/plans/local_approvals.md` for detailed implementation plan and `thoughts/shared/research/2025-06-27_15-49-08_local-approvals-mvp.md` for architecture analysis.

Full plan url: [https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/allison/plans/local_approvals.md](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/allison/plans/local_approvals.md)

Comments:
[2025-06-30] Dexter Horthy:
cool sounds good. lets ship it

[2025-06-30] allison@humanlayer.dev:
~~We are using \_ for all current config options. Would be odd to make this one different?~~ NVM, I see you mean identifier not config option. Yeah that's fine.

![image.png](https://uploads.linear.app/3ee2840f-7196-42ab-91f2-73ab50c48671/5ee93297-bdee-46fe-899f-06fca98c0f98/0db41b65-b517-4d8f-a3e0-9716ecdc9875)

2. Yeah it's fine to be default
3. Integration tests. I think removing cloud is more scope than just having it live alongside for now. And when we get into cloud syncing approvals later it helps to have the existing code implementation details in there already
4. Daemon is running no matter what claude approvals are running. It's very possible for the daemon to have both local and remote approvals coming into it. The daemon will support and serve local approval support no matter what. The only difference is if it happens to get them or not. I think it's easier to bring them alongside eachother. Less changes overall. A bigger rewrite and a bigger PR to scrap the remote approvals workflow imo. Like 2x or so.

[2025-06-30] Dexter Horthy:
@allison looks great, few comments

1. can we change prefix to \`local-\` instead of `local_` - if its all the same, want to preserve that "call ids could be identifiers in k8s someday" just in case
2. `viper.SetDefault("local_approvals", false)` - plan to make this default to true soon? Any reason not to make it true everywhere
3. if we all switch to local approvals, how will we maintain confidence that the non-local version works? answer can be "we wont" or "not worth it" but then we should just kill all cloud approvals, since we'll probably need to redesign it soon anyways - just trying to limit surface area
4. in **Implementation Details: - **[**GetPendingApprovals**](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/allison/plans/local_approvals.md#:\~:text=Make%20polling%20conditional-,Implementation%20Details%3A,-GetPendingApprovals%20(hld) (`hld/approval/manager.go`)
   1. what's your reasoning for not checking the flag in the first if block as well?
   2. Seeing comment for mixed mode - curious how important that is in the short term? I'm fine to move out of scope for now - i expect local approvals interface to *evolve* a lot and then we'll bake that into upstream/cloud stuff.
5. i think thats it

if you ack that then I'm good to move this to ready for dev 

[2025-06-25] Dexter Horthy:
waiting on [ENG-1411](https://linear.app/humanlayer/issue/ENG-1411/update-protocol-with-serveropenapi-for-streamingrestetc) 


View in Linear: https://linear.app/humanlayer/issue/ENG-1445/local-approvals-allowing-approvedeny-without-humanlayer-involvement
