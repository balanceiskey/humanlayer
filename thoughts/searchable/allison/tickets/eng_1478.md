
[ENG-1478] Track and store parent-child relationships for Claude sub-task events in hld
Status: Done
Assignee: allison@humanlayer.dev

Description:
Currently, the hld daemon stores all Claude events flat without preserving parent-child relationships. Sub-task events contain `parent_tool_use_id` but this relationship is not tracked or stored, making it impossible to properly correlate sub-tasks with their parent Task calls.

## Problem

* Events with `parent_tool_use_id` are stored flat in SQLite (`hld/store/sqlite.go:591`)
* No way to query events by parent task
* Cannot determine task hierarchy or nesting depth
* Makes proper UI display impossible

## Solution

* Add parent tracking to event storage schema
* Update event processing to preserve `parent_tool_use_id` relationships
* Consider adding indexes for efficient parent-child queries
* Expose parent relationships through API endpoints

## Implementation Notes

* Check `hld/session/manager.go:508-696` for event processing pipeline
* Update `StreamEvent` handling to track parent relationships
* May need schema migration for existing sessions

## References

* Source: `thoughts/shared/research/2025-06-30_15-00-22_claude_subtask_event_streaming.md`
* GitHub: [https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-06-30_15-00-22_claude_subtask_event_streaming.md](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-06-30_15-00-22_claude_subtask_event_streaming.md)
* Key code: `hld/session/manager.go:209`, `hld/store/sqlite.go:591`

Comments:
[2025-07-02] Dexter Horthy:
this is super helpful - thanks for sharing

[2025-07-02] allison@humanlayer.dev:
I write a custom prompt every time currently. I use `/research_codebase` as the first message normally because it primes claude in a way that I like. I've sorta been adapting as I make plans too and learn what works and doesn't. For this one specifically, I did:

1. `linear get-issue ENG-1478 > thoughts/allison/tickets/eng_1478.md` (this uses my `hack/linear` tool I created when I first got here. I've just been collecting tickets I work on in that directory. It's not perfect but it's quick and dirty and I prefer to have the markdown for this type of task than to use the MCP server (I really only use that for creating tickets or adding comments and such).
2. Launched claude and ran `/research_codebase`. Claude responds with `I'm ready to research the codebase. Please provide your research question or area of interest, and I'll analyze it thoroughly by exploring relevant components and connections.`.
3. I then wrote the prompt:

```
We decided to make it easier this time. I think we literally just need an implementation plan to add the parent mapping to the sqlite database. As far as backend changes go it should be
  super sipmle. We do need an implementation plan. It can be written to `thoughts/allison/plans/{name}.md`. Our goal will be to make sure it's fully filled out with all things we need to
  change. We're in the "Spec writing" part of the process. I think one good example of an implementation plan is located at
  `thoughts/shared/research/2025-06-24_17-11-31_sessionleaves_endpoint_implementation_plan.md` and another one at `thoughts/allison/plans/local_approvals_v2.md`. The key will be to have
  success criteria for each step (based on our research and understanding of the scope of work). `/tmp/claude_stream_output.json` has example streaming output of what I believe is a sub task
  spawn. We used it in our original research of the issue. That can be used to verify the naming of the thing. Also does claudecode-go need to be updated? Are we already handling the event
  type coming in? Why isn't this field already in the database for example? I imagine it should have been if claudecode-go was up to date? These are some open questions. We should probably
  get aligned and on the same page as far as ideas for implementation plan before we write the full thing. Let's get to work :)
```

previously I didn't have plan docs that I liked as "good examples", but I had a really smoothe sailing time with the local_approvals_v2 one (which I edited a fair amount after the original that was approved) and I had also just edited the sessionleaves one a more medium amount to be a clear format that I thought would work without hiccups (I don't think I had to decline a single edit request, maybe one? But definitely didn't have back and forth.). The json file was generated by doing this during research:

```
claude -p "spawn a sub task that reads at least 5 files. Do not read any files in the primary context. Have the sub task tell you what files it chose to read and what was in them" --output-format stream-json --verbose > /tmp/claude_stream_output.json 2>&1
```

So I just figured it had all the data the task should need that isn't inside the codebase and I didn't want to have to spend cycles on looking at what the actual field name was or where it integrates into claudecode-go vs hld etc.

I had to do some back and forth with it to get it the way I wanted it to. It went on it's own until the first plan write attempt, I wrote this:

```
Some feedback:

  ```
         135 +      convEvent := &store.ConversationEvent{
         136 +          SessionID:       sessionID,
         137 +          ClaudeSessionID: claudeSessionID,
         138 +          EventType:       store.EventTypeToolCall,
         139 +          ToolID:          content.ID,
         140 +          ToolName:        content.Name,
         141 +          ToolInputJSON:   string(inputJSON),
         142 +          ParentToolUseID: event.ParentToolUseID,  // NEW: Capture parent ID
         143 +      }
  ```

  Why is parentToolUseID on the event object but none of the other things are on event? Should this actually be content? Or is parent tool use id in a different part of the object?

  Wait, is it already included in the json field? Is that why? Or is it different?

  Note, we don't need to include any "future enhancments" or things unrelated to this change. Note, we for sure need to make sure the conversation events (returned from getConversation)
  include the new field. But also if it's possible that parent_tool_use_id is already in the json and thus the frontend can already see it then it's possible we don't need to do all this?
  Maybe it's still wise to store in sqlite and return as a dedicated field but I guess I just want clarity on what that is and why other things use content but parentToolUseID is using event.
   Also what else is on "event" that we're currently not using?
```

Then it went off and did stuff and then wrote the final version (I guess I only needed to respond once)

[2025-07-02] Dexter Horthy:
@allison this spec looks great - one question - do you have a special prompt for making these phased plans or is that just claude code out of the box? 

[2025-07-02] allison@humanlayer.dev:
Added full spec for review to links - moving to spec in review

[2025-07-02] Dexter Horthy:
discussion - use flat events, just start storing parent tool call id, assemble some FE prototypes, once FE design is baked we can consider "write it the way you're gonna read it" approach and move more logic into the db/daemon


View in Linear: https://linear.app/humanlayer/issue/ENG-1478/track-and-store-parent-child-relationships-for-claude-sub-task-events
