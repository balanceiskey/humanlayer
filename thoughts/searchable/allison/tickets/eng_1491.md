
[ENG-1491] Implement getSessionLeaves JSON-RPC endpoint to show only leaf sessions
Status: ready for dev
Assignee: allison@humanlayer.dev

Description:
## Implementation Plan

[**ðŸ“– Full implementation plan on GitHub**](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-06-24_17-11-31_sessionleaves_endpoint_implementation_plan.md)

Currently, all session listing endpoints return ALL sessions without filtering, causing UI clutter when sessions have parent-child relationships. We need to implement the `getSessionLeaves` endpoint that returns only leaf nodes (sessions with no children) as designed in the comprehensive research document above.

## Background

* **Related ticket**: [ENG-1437](https://linear.app/humanlayer/issue/ENG-1437) marked as done, but only implemented query injection (PR #251) - a prerequisite for session forking
* **Blocker for**: [ENG-1490](https://linear.app/humanlayer/issue/ENG-1490) - esc-esc forking functionality requires session leaves to work properly

## What's Already Done

PR #251 implemented the query injection system that properly handles queries in parent-child session relationships. This was foundational work needed before implementing session leaves.

## What Needs Implementation

1. **Backend**: Add `getSessionLeaves` JSON-RPC method that builds in-memory tree and returns only leaf nodes
2. **Database**: Add index on `parent_session_id` for efficient queries
3. **Clients**: Update all three clients (WUI, TUI, hlyr) to use new endpoint
4. **Migration**: Frontend fallback logic during transition

## Key Implementation Details

* New JSON-RPC method: `getSessionLeaves`
* Returns `SessionInfo[]` with optional `depth` field
* Filters to only sessions with no children
* Maintains backwards compatibility

## Research Documents

* [Session leaves implementation plan](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-06-24_17-11-31_sessionleaves_endpoint_implementation_plan.md) - Comprehensive spec
* [Session fork display API analysis](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-06-24_16-33-46_session_fork_display_api.md) - API design options
* [Implementation status research](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-07-01_11-26-51_session_leaves_implementation_status.md) - Current state analysis

Comments:
[2025-07-01] Dexter Horthy:
a few questions @allison @sundeep 

1. what is this stuff about depthIndicator? I can see that for subtasks but I would think we actually want to show leaf-children-of-continued-sesssions as flat?? 
   
   // Display sessions with depth indicator
   sessions.forEach(session => {
     // Show depth as subtle indicator (e.g., indentation or nested icon)
     const depthIndicator = 'â”—'.repeat(session.depth || 0)
     console.log(\`${depthIndicator} ${session.query}\`)
   })
2. do we really need to include the update specs for TUI as well? do we use that? do we want to archive it for now?
3. CLI usage for hlyr [https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-06-24_17-11-31_sessionleaves_endpoint_implementation_plan.md#cli-usage-hlyr](https://github.com/humanlayer/thoughts/blob/main/repos/humanlayer/shared/research/2025-06-24_17-11-31_sessionleaves_endpoint_implementation_plan.md#cli-usage-hlyr) when/where would we do that? is there intent to add a `npx humanlayer sessions ls` or something? Otherwise feels irrelevant/misleading
4. this does not specify the actual behavior-changing change afaict - i don't see where we replace the current session list usage with listing the session leaves

[2025-07-01] allison@humanlayer.dev:
1. Yeah we don't need the session indicator stuff. That is silly. I'll remove. The TUI example is much more like what will actually happen in wui (Simply change getSessions to getSessionLeaves)
2. Can remove TUI from instruction set. We can archive. Part of this ticket :an be updating the README.md file explicitly saying it's archived to focus on WUI (And I'll see if I need to add anything else to ai-readable versions of files. maybe humanlayer-tui/CLAUDE.md can have a disclaimer that tui is archived and it can be used as reference but does not need to have new features or updates to avoid this type of plan in the future)
3. Nope, CLI stuff is irrelevant. Think this was just artifacts around the prompt "All clients *should* be able to use this" as my way to make sure the go and the rust and the ts side could all be happy with what ends up being settled on. I'll remove.
4. On the wui side, it should just be replacing anywhere `listSessions` is used with `listSessionLeaves` (2 places used). I'll make sure to update plan to be explicit about this, but this was the idea.

[2025-07-01] Dexter Horthy:
cool sounds like we are are aligned so good to move this to ready for dev

View in Linear: https://linear.app/humanlayer/issue/ENG-1491/implement-getsessionleaves-json-rpc-endpoint-to-show-only-leaf
